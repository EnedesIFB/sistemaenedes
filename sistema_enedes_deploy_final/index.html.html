<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ENEDES - Gestão Completa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Estilos customizados para manter a aparência idêntica ao React */
        .gradient-bg {
            background: linear-gradient(135deg, #10B981, #3B82F6);
        }
        
        .shadow-custom {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .backdrop-blur-custom {
            backdrop-filter: blur(12px);
        }
        
        /* Animações */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Container principal -->
    <div id="app" class="min-h-screen">
        <!-- Tela de carregamento -->
        <div id="loading" class="fixed inset-0 bg-gradient-to-br from-green-600 via-green-700 to-blue-800 flex items-center justify-center z-50">
            <div class="text-center text-white">
                <div class="mb-4">
                    <div id="logo-container"></div>
                </div>
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto"></div>
                <p class="mt-4 text-lg">Carregando Sistema ENEDES...</p>
            </div>
        </div>
        
        <!-- Modal de Login -->
        <div id="loginModal" class="fixed inset-0 bg-gradient-to-br from-green-600 via-green-700 to-blue-800 flex items-center justify-center p-4 fade-in" style="display: none;">
            <div class="bg-white/95 backdrop-blur-md rounded-3xl p-12 max-w-md w-full shadow-2xl slide-up">
                <div class="text-center mb-8">
                    <div id="logo-login"></div>
                    <h2 class="text-2xl font-bold text-gray-800 mt-6 mb-2">Sistema ENEDES</h2>
                    <p class="text-gray-600">Gestão Completa</p>
                </div>

                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Selecione o usuário:
                        </label>
                        <select id="selectedUser" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-colors">
                            <option value="">Escolha um usuário...</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Senha:
                        </label>
                        <input type="password" id="password" value="123456" class="w-full p-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none transition-colors">
                    </div>

                    <div class="flex flex-col gap-3">
                        <button id="loginSubmit" class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            Entrar no Sistema
                        </button>
                        <button id="loginDirect" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-3 rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-105">
                            🚀 Login Direto (Demo)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sistema Principal -->
        <div id="mainSystem" style="display: none;" class="fade-in">
            <!-- Header -->
            <div class="bg-white shadow-sm border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-20">
                        <div id="logo-header"></div>
                        
                        <div class="flex items-center gap-4">
                            <!-- Botão de notificações -->
                            <button id="notificationBtn" class="relative p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
                                <i data-lucide="bell" class="w-5 h-5"></i>
                                <span id="unreadCount" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center" style="display: none;">0</span>
                            </button>

                            <div class="flex items-center gap-2 text-sm">
                                <i data-lucide="user" class="w-4 h-4 text-gray-500"></i>
                                <span id="userName" class="text-gray-700"></span>
                                <span id="userRole" class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs"></span>
                            </div>
                            
                            <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                Exportar
                            </button>
                            
                            <button id="logoutBtn" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                <i data-lucide="log-out" class="w-4 h-4"></i>
                                Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Navegação -->
            <div class="bg-white border-b border-gray-200">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    <div id="navigation" class="flex space-x-1 py-3 overflow-x-auto">
                        <!-- Navegação será preenchida dinamicamente -->
                    </div>
                </div>
            </div>

            <!-- Conteúdo principal -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div id="content">
                    <!-- Conteúdo será carregado dinamicamente -->
                </div>
            </div>
        </div>
        
        <!-- Toast de notificações -->
        <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-4">
            <!-- Toasts serão inseridos aqui -->
        </div>
    </div>

    <script>
        // ================================================
        // VARIÁVEIS GLOBAIS
        // ================================================
        
        let currentUser = null;
        let currentSection = '';
        let actions = {};
        let users = {};
        let collaborators = {};
        let followUps = {};
        let notifications = [];
        let unreadCount = 0;
        
        // ================================================
        // INICIALIZAÇÃO DO SISTEMA
        // ================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Renderizar logos
            renderLogos();
            
            // Inicializar ícones Lucide
            lucide.createIcons();
            
            // Carregar usuários e mostrar tela de login
            loadUsers();
            
            // Event listeners
            setupEventListeners();
            
            // Esconder loading e mostrar login
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginModal').style.display = 'flex';
            }, 1500);
        });
        
        // ================================================
        // FUNÇÕES DE RENDERIZAÇÃO DE LOGO
        // ================================================
        
        function renderLogos() {
            const logoSVG = `
                <svg width="320" height="80" viewBox="0 0 640 160" class="h-12">
                    <defs>
                        <linearGradient id="greenGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#4CAF50" stop-opacity="1" />
                            <stop offset="100%" stop-color="#2E7D32" stop-opacity="1" />
                        </linearGradient>
                        <linearGradient id="orangeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" stop-color="#FF9800" stop-opacity="1" />
                            <stop offset="100%" stop-color="#F57C00" stop-opacity="1" />
                        </linearGradient>
                    </defs>
                    
                    <rect x="20" y="25" width="60" height="90" rx="12" fill="url(#greenGradient)"/>
                    <rect x="28" y="40" width="35" height="12" fill="white"/>
                    <rect x="28" y="60" width="28" height="12" fill="white"/>
                    <rect x="28" y="80" width="35" height="12" fill="white"/>
                    <rect x="50" y="52" width="22" height="16" fill="url(#orangeGradient)"/>
                    
                    <text x="95" y="75" font-family="Arial, sans-serif" font-size="36" font-weight="bold" fill="#4A6FA5">enedes</text>
                    
                    <rect x="95" y="85" width="220" height="2" fill="#FF9800"/>
                    
                    <text x="95" y="105" font-family="Arial, sans-serif" font-size="12" fill="#4A6FA5">Escola de Negócios e Desenvolvimento Social</text>
                    <text x="95" y="120" font-family="Arial, sans-serif" font-size="12" fill="#4A6FA5">do Instituto Federal de Brasília</text>
                </svg>
            `;
            
            document.getElementById('logo-container').innerHTML = logoSVG;
            document.getElementById('logo-login').innerHTML = logoSVG;
            document.getElementById('logo-header').innerHTML = logoSVG;
        }
        
        // ================================================
        // FUNÇÕES DE API
        // ================================================
        
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`api.php?endpoint=${endpoint}`, options);
                return await response.json();
                
            } catch (error) {
                console.error('Erro na API:', error);
                return { success: false, message: 'Erro de conexão' };
            }
        }
        
        // ================================================
        // FUNÇÕES DE LOGIN
        // ================================================
        
        async function loadUsers() {
            const result = await apiCall('users');
            if (result.success) {
                users = result.users;
                populateUserSelect();
            }
        }
        
        function populateUserSelect() {
            const select = document.getElementById('selectedUser');
            select.innerHTML = '<option value="">Escolha um usuário...</option>';
            
            for (const [username, user] of Object.entries(users)) {
                if (user.isActive) {
                    const roleIcon = getRoleIcon(user.role);
                    const option = document.createElement('option');
                    option.value = username;
                    option.textContent = `${roleIcon} ${user.name}`;
                    select.appendChild(option);
                }
            }
        }
        
        async function handleLogin(username, password) {
            const result = await apiCall('login', 'POST', { username, password });
            
            if (result.success) {
                currentUser = result.user;
                showNotification('Login realizado com sucesso!', `Bem-vindo, ${currentUser.name}`, 'success');
                
                // Esconder modal de login e mostrar sistema
                document.getElementById('loginModal').style.display = 'none';
                document.getElementById('mainSystem').style.display = 'block';
                
                // Carregar dados do sistema
                await loadSystemData();
                
                // Renderizar interface
                renderUserInfo();
                renderNavigation();
                renderDashboard();
                
            } else {
                showNotification('Erro de login', result.message, 'error');
            }
        }
        
        function handleLogout() {
            showNotification('Logout realizado', `Até logo, ${currentUser?.name}`, 'info');
            currentUser = null;
            currentSection = '';
            
            // Mostrar login novamente
            document.getElementById('mainSystem').style.display = 'none';
            document.getElementById('loginModal').style.display = 'flex';
        }
        
        // ================================================
        // FUNÇÕES DE CARREGAMENTO DE DADOS
        // ================================================
        
        async function loadSystemData() {
            // Carregar ações
            const actionsResult = await apiCall('actions');
            if (actionsResult.success) {
                actions = actionsResult.actions;
            }
            
            // Carregar colaboradores
            const collaboratorsResult = await apiCall('collaborators');
            if (collaboratorsResult.success) {
                collaborators = collaboratorsResult.collaborators;
            }
            
            // Carregar notificações
            const notificationsResult = await apiCall('notifications');
            if (notificationsResult.success) {
                notifications = notificationsResult.notifications;
                updateNotificationCount();
            }
        }
        
        // ================================================
        // FUNÇÕES DE RENDERIZAÇÃO DA INTERFACE
        // ================================================
        
        function renderUserInfo() {
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').innerHTML = `${getRoleIcon(currentUser.role)} ${getRoleDisplayName(currentUser.role)}`;
        }
        
        function renderNavigation() {
            const nav = document.getElementById('navigation');
            nav.innerHTML = '';
            
            // Dashboard
            const dashboardBtn = createNavButton('📊 Dashboard', '', currentSection === '');
            dashboardBtn.onclick = () => {
                currentSection = '';
                renderNavigation();
                renderDashboard();
            };
            nav.appendChild(dashboardBtn);
            
            // Seções do usuário
            if (currentUser.sections) {
                currentUser.sections.forEach(section => {
                    const btn = createNavButton(section, section, currentSection === section);
                    btn.onclick = () => {
                        currentSection = section;
                        renderNavigation();
                        renderSectionView(section);
                    };
                    nav.appendChild(btn);
                });
            }
            
            // Gestão de pessoas (apenas para coordenadores)
            if (canManageUsers(currentUser)) {
                const usersBtn = createNavButton('👥 Gestão de Pessoas', 'users', currentSection === 'users');
                usersBtn.onclick = () => {
                    currentSection = 'users';
                    renderNavigation();
                    renderUsersManagement();
                };
                nav.appendChild(usersBtn);
            }
        }
        
        function createNavButton(text, value, isActive) {
            const button = document.createElement('button');
            button.className = `px-4 py-2 rounded-lg font-medium transition-all whitespace-nowrap ${
                isActive 
                    ? 'bg-green-100 text-green-800 shadow-sm' 
                    : 'text-gray-600 hover:text-gray-800 hover:bg-gray-100'
            }`;
            button.textContent = text;
            return button;
        }
        
        // ================================================
        // FUNÇÕES DE RENDERIZAÇÃO DE CONTEÚDO
        // ================================================
        
        function renderDashboard() {
            const content = document.getElementById('content');
            const stats = calculateStats();
            
            content.innerHTML = `
                <div class="space-y-8">
                    <!-- Cards de métricas -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        ${renderStatsCard('Total de Ações', stats.total, 'target', 'green')}
                        ${renderStatsCard('Concluídas', stats.completed, 'check-circle', 'blue')}
                        ${renderStatsCard('Em Andamento', stats.inProgress, 'clock', 'yellow')}
                        ${renderStatsCard('Em Alerta', stats.alert, 'alert-triangle', 'red')}
                    </div>
                    
                    <!-- Resumo por seção -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">📋 Resumo por Seção</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderSectionSummary()}
                        </div>
                    </div>
                </div>
            `;
            
            // Inicializar ícones
            lucide.createIcons();
        }
        
        function renderStatsCard(title, value, icon, color) {
            const colors = {
                green: 'from-green-500 to-green-600 text-green-200',
                blue: 'from-blue-500 to-blue-600 text-blue-200',
                yellow: 'from-yellow-500 to-yellow-600 text-yellow-200',
                red: 'from-red-500 to-red-600 text-red-200'
            };
            
            return `
                <div class="bg-gradient-to-br ${colors[color].split(' ')[0]} ${colors[color].split(' ')[1]} text-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="${colors[color].split(' ')[2]} text-sm">${title}</p>
                            <p class="text-3xl font-bold">${value}</p>
                        </div>
                        <i data-lucide="${icon}" class="w-12 h-12 ${colors[color].split(' ')[2]}"></i>
                    </div>
                </div>
            `;
        }
        
        function renderSectionSummary() {
            if (!currentUser.sections) return '';
            
            return currentUser.sections.map(section => {
                const sectionActions = actions[section] || [];
                const completed = sectionActions.filter(a => a.completed).length;
                const total = sectionActions.length;
                const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                return `
                    <div class="bg-gray-50 p-4 rounded-xl border-l-4 border-green-500 cursor-pointer hover:bg-gray-100 transition-colors" 
                         onclick="selectSection('${section}')">
                        <h5 class="font-semibold text-gray-800 mb-2">${section}</h5>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-600">Progresso:</span>
                            <span class="font-bold text-gray-900">${completed}/${total} (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-300 ${getProgressColor(percentage)}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSectionView(sectionName) {
            const content = document.getElementById('content');
            const sectionActions = actions[sectionName] || [];
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Header da seção -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-2xl font-bold text-gray-800">${sectionName}</h2>
                            <button onclick="openActionModal()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg hover:shadow-xl flex items-center font-semibold">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                Nova Ação
                            </button>
                        </div>
                        
                        <!-- Filtros -->
                        <div class="flex flex-wrap gap-4 items-center">
                            <div class="flex items-center gap-2">
                                <i data-lucide="search" class="w-4 h-4 text-gray-500"></i>
                                <input type="text" id="searchTerm" placeholder="Buscar ações..." 
                                       class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div class="flex items-center gap-2">
                                <i data-lucide="filter" class="w-4 h-4 text-gray-500"></i>
                                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                    <option value="">Todos os status</option>
                                    <option value="em_andamento">Em Andamento</option>
                                    <option value="concluida">Concluída</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="alerta">Alerta</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de ações -->
                    <div id="actionsList" class="space-y-4">
                        ${renderActionsList(sectionActions)}
                    </div>
                </div>
            `;
            
            // Inicializar ícones
            lucide.createIcons();
        }
        
        function renderActionsList(actionsList) {
            if (actionsList.length === 0) {
                return `
                    <div class="bg-white p-12 rounded-2xl shadow-lg border text-center">
                        <i data-lucide="file-text" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-600 mb-2">Nenhuma ação encontrada</h3>
                        <p class="text-gray-500">Adicione uma nova ação ou ajuste os filtros de busca.</p>
                    </div>
                `;
            }
            
            return actionsList.map(action => renderActionCard(action)).join('');
        }
        
        function renderActionCard(action) {
            const completedTasks = action.tasks?.filter(t => t.completed).length || 0;
            const totalTasks = action.tasks?.length || 0;
            
            return `
                <div class="bg-white p-6 rounded-2xl shadow-lg border hover:shadow-xl transition-shadow">
                    <!-- Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">${action.task}</h3>
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="px-3 py-1 rounded-full text-sm font-medium border ${getStatusColor(action.status)} flex items-center gap-1">
                                    ${getStatusIcon(action.status)}
                                    ${getStatusText(action.status)}
                                </span>
                                ${action.priority ? `<span class="px-3 py-1 rounded-full text-sm font-medium ${getPriorityColor(action.priority)}">${getPriorityText(action.priority)}</span>` : ''}
                                ${action.completed ? '<span class="px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">✅ Concluída</span>' : ''}
                                ${action.validated ? '<span class="px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">✓ Validada</span>' : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editAction(${action.id})" class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors" title="Editar">
                                <i data-lucide="edit" class="w-4 h-4"></i>
                            </button>
                            <button onclick="openFollowUpModal(${action.id})" class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-colors" title="Follow-up">
                                <i data-lucide="flag" class="w-4 h-4"></i>
                            </button>
                            <button onclick="sendTask(${action.id})" class="p-2 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors" title="Enviar Tarefa">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteAction(${action.id})" class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors" title="Excluir">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Barra de progresso -->
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-gray-700">Progresso</span>
                            <span class="text-sm font-bold text-gray-900">${action.progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="h-3 rounded-full transition-all duration-300 ${getProgressColor(action.progress)}" 
                                 style="width: ${action.progress}%"></div>
                        </div>
                    </div>
                    
                    <!-- Detalhes -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-600">👤 Responsável:</span>
                            <p class="text-gray-800">${action.responsible}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">📅 Deadline:</span>
                            <p class="text-gray-800">${formatDate(action.deadline)}</p>
                        </div>
                        <div>
                            <span class="font-medium text-gray-600">💰 Orçamento:</span>
                            <p class="text-gray-800">${action.budget || 'Não informado'}</p>
                        </div>
                    </div>
                    
                    ${action.description ? `
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                            <span class="font-medium text-gray-600">📝 Descrição:</span>
                            <p class="text-gray-800 mt-1">${action.description}</p>
                        </div>
                    ` : ''}
                    
                    ${action.tasks && action.tasks.length > 0 ? `
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg">
                            <span class="font-medium text-gray-600">✅ Tarefas (${completedTasks}/${totalTasks} concluídas):</span>
                            <div class="mt-2 space-y-1">
                                ${action.tasks.slice(0, 3).map(task => `
                                    <div class="flex items-center gap-2 text-sm">
                                        <div class="w-3 h-3 rounded-full ${task.completed ? 'bg-green-500' : 'bg-gray-300'}"></div>
                                        <span class="${task.completed ? 'line-through text-gray-500' : 'text-gray-700'}">${task.description}</span>
                                    </div>
                                `).join('')}
                                ${action.tasks.length > 3 ? `<p class="text-xs text-gray-500 ml-5">+ ${action.tasks.length - 3} mais tarefas...</p>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${action.attachments && action.attachments.length > 0 ? `
                        <div class="mb-4 p-3 bg-yellow-50 rounded-lg">
                            <span class="font-medium text-gray-600">📎 Anexos (${action.attachments.length}):</span>
                            <div class="mt-2 flex flex-wrap gap-2">
                                ${action.attachments.map(file => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">📄 ${file}</span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${action.note ? `
                        <div class="p-3 bg-yellow-100 border-l-4 border-yellow-500 rounded">
                            <span class="font-medium text-gray-600">📝 Observações:</span>
                            <p class="text-gray-800 mt-1">${action.note}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        function renderUsersManagement() {
            const content = document.getElementById('content');
            
            content.innerHTML = `
                <div class="space-y-8">
                    <!-- Header -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">👥 Gestão de Pessoas</h2>
                            <div class="flex gap-3">
                                <button onclick="openCollaboratorModal()" class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg hover:shadow-xl flex items-center font-semibold">
                                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                                    Novo Colaborador
                                </button>
                                <button onclick="openUserModal()" class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-green-800 transition-all shadow-lg hover:shadow-xl flex items-center font-semibold">
                                    <i data-lucide="user-plus" class="w-5 h-5 mr-2"></i>
                                    Novo Usuário
                                </button>
                            </div>
                        </div>
                        
                        <!-- Estatísticas -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-blue-800">Total de Usuários</h3>
                                <p class="text-2xl font-bold text-blue-900">${Object.keys(users).length}</p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-green-800">Usuários Ativos</h3>
                                <p class="text-2xl font-bold text-green-900">${Object.values(users).filter(u => u.isActive).length}</p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-purple-800">Total de Colaboradores</h3>
                                <p class="text-2xl font-bold text-purple-900">${Object.keys(collaborators).length}</p>
                            </div>
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h3 class="font-semibold text-yellow-800">Colaboradores Ativos</h3>
                                <p class="text-2xl font-bold text-yellow-900">${Object.values(collaborators).filter(c => c.isActive).length}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Colaboradores -->
                    <div class="bg-white p-6 rounded-2xl shadow-lg border">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">👥 Colaboradores</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderCollaboratorsList()}
                        </div>
                    </div>
                </div>
            `;
            
            // Inicializar ícones
            lucide.createIcons();
        }
        
        function renderCollaboratorsList() {
            return Object.entries(collaborators).map(([id, collaborator]) => `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-gray-800">${collaborator.name}</h4>
                        <span class="w-3 h-3 rounded-full ${collaborator.isActive ? 'bg-green-500' : 'bg-red-500'}"></span>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600">
                        <p><strong>Email:</strong> ${collaborator.email}</p>
                        <p><strong>Telefone:</strong> ${collaborator.phone || '-'}</p>
                        <p><strong>Departamento:</strong> ${collaborator.department || '-'}</p>
                        <p><strong>Cargo:</strong> ${collaborator.position || '-'}</p>
                        
                        ${collaborator.skills && collaborator.skills.length > 0 ? `
                            <div>
                                <strong>Habilidades:</strong>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    ${collaborator.skills.map(skill => `
                                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">${skill}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <span class="text-xs text-gray-500">
                            Cadastrado em ${formatDate(collaborator.createdAt)}
                        </span>
                        <button onclick="toggleCollaboratorStatus('${id}')" class="p-1 rounded transition-colors ${collaborator.isActive ? 'text-red-600 hover:bg-red-100' : 'text-green-600 hover:bg-green-100'}" title="${collaborator.isActive ? 'Desativar' : 'Ativar'}">
                            <i data-lucide="${collaborator.isActive ? 'bell-off' : 'bell'}" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // ================================================
        // FUNÇÕES AUXILIARES
        // ================================================
        
        function selectSection(section) {
            currentSection = section;
            renderNavigation();
            renderSectionView(section);
        }
        
        function getRoleIcon(role) {
            const roleIcons = {
                general_coordinator: '👑',
                project_coordinator: '🎯',
                department_coordinator: '👤'
            };
            return roleIcons[role] || '👤';
        }
        
        function getRoleDisplayName(role) {
            const roleNames = {
                general_coordinator: 'Coordenador Geral',
                project_coordinator: 'Coordenador de Projeto',
                department_coordinator: 'Coordenador de Departamento'
            };
            return roleNames[role] || role;
        }
        
        function canManageUsers(user) {
            return user?.role === 'general_coordinator' || user?.role === 'project_coordinator';
        }
        
        function getStatusIcon(status) {
            const icons = {
                concluida: '<i data-lucide="check-circle" class="w-4 h-4 text-green-600"></i>',
                em_andamento: '<i data-lucide="clock" class="w-4 h-4 text-blue-600"></i>',
                alerta: '<i data-lucide="alert-triangle" class="w-4 h-4 text-yellow-600"></i>',
                pendente: '<i data-lucide="x-circle" class="w-4 h-4 text-gray-600"></i>',
                atrasado: '<i data-lucide="x-circle" class="w-4 h-4 text-red-600"></i>'
            };
            return icons[status] || icons.pendente;
        }
        
        function getStatusText(status) {
            const texts = {
                concluida: "Concluída",
                em_andamento: "Em Andamento", 
                alerta: "Alerta",
                pendente: "Pendente",
                atrasado: "Atrasado"
            };
            return texts[status] || status;
        }
        
        function getStatusColor(status) {
            const colors = {
                concluida: "bg-green-100 text-green-800 border-green-300",
                em_andamento: "bg-blue-100 text-blue-800 border-blue-300",
                alerta: "bg-yellow-100 text-yellow-800 border-yellow-300",
                pendente: "bg-gray-100 text-gray-800 border-gray-300",
                atrasado: "bg-red-100 text-red-800 border-red-300"
            };
            return colors[status] || colors.pendente;
        }
        
        function getPriorityColor(priority) {
            const colors = {
                high: "bg-red-100 text-red-800",
                medium: "bg-yellow-100 text-yellow-800",
                low: "bg-green-100 text-green-800"
            };
            return colors[priority] || colors.medium;
        }
        
        function getPriorityText(priority) {
            const texts = {
                high: "🔴 Alta",
                medium: "🟡 Média",
                low: "🟢 Baixa"
            };
            return texts[priority] || priority;
        }
        
        function getProgressColor(progress) {
            if (progress >= 70) return "bg-green-500";
            if (progress >= 40) return "bg-yellow-500";
            return "bg-red-500";
        }
        
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('pt-BR');
        }
        
        function calculateStats() {
            const allActions = Object.values(actions).flat();
            let userActions = [];

            if (currentUser?.role === 'general_coordinator' || currentUser?.role === 'project_coordinator') {
                userActions = allActions;
            } else {
                userActions = allActions.filter(action => 
                    currentUser?.sections.some(section => {
                        const sectionActions = actions[section] || [];
                        return sectionActions.includes(action);
                    })
                );
            }

            return {
                total: userActions.length,
                completed: userActions.filter(a => a.completed).length,
                inProgress: userActions.filter(a => a.status === 'em_andamento').length,
                alert: userActions.filter(a => a.status === 'alerta').length
            };
        }
        
        function updateNotificationCount() {
            const count = notifications.filter(n => !n.is_read).length;
            unreadCount = count;
            const badge = document.getElementById('unreadCount');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // ================================================
        // SISTEMA DE NOTIFICAÇÕES
        // ================================================
        
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const id = 'toast_' + Date.now();
            
            const colors = {
                success: 'border-green-500',
                warning: 'border-yellow-500',
                error: 'border-red-500',
                info: 'border-blue-500'
            };
            
            const icons = {
                success: 'check-circle',
                warning: 'alert-triangle',
                error: 'x-circle',
                info: 'clock'
            };
            
            const toast = document.createElement('div');
            toast.id = id;
            toast.className = `max-w-sm w-full bg-white rounded-lg shadow-lg border-l-4 ${colors[type]} p-4 mb-4 slide-up`;
            
            toast.innerHTML = `
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="${icons[type]}" class="w-5 h-5 text-${type === 'success' ? 'green' : type === 'warning' ? 'yellow' : type === 'error' ? 'red' : 'blue'}-600"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">${title}</p>
                        <p class="text-sm text-gray-500 mt-1">${message}</p>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <button onclick="removeToast('${id}')" class="text-gray-400 hover:text-gray-600 transition-colors">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `;
            
            container.appendChild(toast);
            lucide.createIcons();
            
            // Auto remover após 5 segundos
            setTimeout(() => {
                removeToast(id);
            }, 5000);
        }
        
        function removeToast(id) {
            const toast = document.getElementById(id);
            if (toast) {
                toast.remove();
            }
        }
        
        // ================================================
        // FUNÇÕES DE MODAL (PLACEHOLDER)
        // ================================================
        
        function openActionModal() {
            showNotification('Funcionalidade em desenvolvimento', 'Modal de nova ação será implementado', 'info');
        }
        
        function openFollowUpModal(actionId) {
            showNotification('Follow-up', `Follow-up para ação ID ${actionId} será implementado`, 'info');
        }
        
        function openUserModal() {
            showNotification('Funcionalidade em desenvolvimento', 'Modal de novo usuário será implementado', 'info');
        }
        
        function openCollaboratorModal() {
            showNotification('Funcionalidade em desenvolvimento', 'Modal de novo colaborador será implementado', 'info');
        }
        
        function editAction(actionId) {
            showNotification('Editar Ação', `Edição da ação ID ${actionId} será implementada`, 'info');
        }
        
        function deleteAction(actionId) {
            if (confirm('Tem certeza que deseja excluir esta ação?')) {
                showNotification('Ação excluída', 'A ação foi excluída com sucesso', 'success');
            }
        }
        
        function sendTask(actionId) {
            showNotification('Enviar Tarefa', `Envio de tarefa ID ${actionId} será implementado`, 'info');
        }
        
        function toggleCollaboratorStatus(collaboratorId) {
            const collaborator = collaborators[collaboratorId];
            collaborator.isActive = !collaborator.isActive;
            showNotification('Status alterado', `${collaborator.name} foi ${collaborator.isActive ? 'ativado' : 'desativado'}`, 'info');
            
            // Re-renderizar se estiver na página de gestão
            if (currentSection === 'users') {
                renderUsersManagement();
            }
        }
        
        // ================================================
        // EVENT LISTENERS
        // ================================================
        
        function setupEventListeners() {
            // Login
            document.getElementById('loginSubmit').addEventListener('click', () => {
                const username = document.getElementById('selectedUser').value;
                const password = document.getElementById('password').value;
                
                if (!username || !password) {
                    showNotification('Campos obrigatórios', 'Selecione um usuário e digite a senha', 'error');
                    return;
                }
                
                handleLogin(username, password);
            });
            
            document.getElementById('loginDirect').addEventListener('click', () => {
                handleLogin('coord_geral', '123456');
            });
            
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Export
            document.getElementById('exportBtn').addEventListener('click', () => {
                const dataToExport = {
                    exportDate: new Date().toISOString(),
                    user: currentUser?.name,
                    userRole: getRoleDisplayName(currentUser?.role),
                    actions: actions,
                    collaborators: collaborators
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ENEDES_Export_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('Dados exportados!', 'Os dados foram exportados com sucesso', 'success');
            });
            
            // Notificações
            document.getElementById('notificationBtn').addEventListener('click', () => {
                showNotification('Central de Notificações', 'Central de notificações será implementada', 'info');
            });
            
            // Enter para login
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loginSubmit').click();
                }
            });
        }
        
        // ================================================
        // INICIALIZAÇÃO FINAL
        // ================================================
        
        // Adicionar estilos dinâmicos para os ícones
        document.addEventListener('DOMContentLoaded', function() {
            const style = document.createElement('style');
            style.textContent = `
                [data-lucide] {
                    width: 1em;
                    height: 1em;
                    display: inline-block;
                    vertical-align: middle;
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>